import{_ as we}from"./router-2c18f3be.js";import"./vendor-8a332d8f.js";var Ve=Object.defineProperty,Ze=(e,n,t)=>n in e?Ve(e,n,{enumerable:!0,configurable:!0,writable:!0,value:t}):e[n]=t,u=(e,n,t)=>(Ze(e,typeof n!="symbol"?n+"":n,t),t),xe=(e,n,t)=>{if(!n.has(e))throw TypeError("Cannot "+t)},H=(e,n,t)=>(xe(e,n,"read from private field"),t?t.call(e):n.get(e)),Ke=(e,n,t)=>{if(n.has(e))throw TypeError("Cannot add the same private member more than once");n instanceof WeakSet?n.add(e):n.set(e,t)},Ye=(e,n,t,s)=>(xe(e,n,"write to private field"),s?s.call(e,t):n.set(e,t),t),re=new Intl.Collator(0,{numeric:1}).compare;function je(e,n,t){return e=e.split("."),n=n.split("."),re(e[0],n[0])||re(e[1],n[1])||(n[2]=n.slice(2).join("."),t=/[.-]/.test(e[2]=e.slice(2).join(".")),t==/[.-]/.test(n[2])?re(e[2],n[2]):t?-1:1)}const Qe="host",Oe="queue/data",Xe="queue/join",ye="upload",et="login",ve="config",tt="info",nt="runtime",st="sleeptime",it="heartbeat",ot="component_server",at="reset",rt="cancel",ct="app_id",lt="https://gradio-space-api-fetcher-v2.hf.space/api",De="This application is currently busy. Please try again. ",R="Connection errored out. ",L="Could not resolve app config. ",ut="Could not get space status. ",pt="Could not get API info. ",pe="Space metadata could not be loaded. ",dt="Invalid URL. A full URL path is required.",ht="Not authorized to access this space. ",Te="Invalid credentials. Could not login. ",ft="Login credentials are required to access this space.",_t="File system access is only available in Node.js environments",qe="Root URL not found in client config",gt="Error uploading file";function mt(e,n,t){return n.startsWith("http://")||n.startsWith("https://")?t?e:n:e+n}async function be(e,n,t){try{return(await(await fetch(`https://huggingface.co/api/spaces/${e}/jwt`,{headers:{Authorization:`Bearer ${n}`,...t?{Cookie:t}:{}}})).json()).token||!1}catch{return!1}}function wt(e){let n={};return e.forEach(({api_name:t,id:s})=>{t&&(n[t]=s)}),n}async function yt(e){const n=this.options.hf_token?{Authorization:`Bearer ${this.options.hf_token}`}:{};if(n["Content-Type"]="application/json",typeof window<"u"&&window.gradio_config&&location.origin!=="http://localhost:9876"&&!window.gradio_config.dev_mode)return window.gradio_config.current_page&&(e=e.substring(0,e.lastIndexOf("/"))),window.gradio_config.root=e,{...window.gradio_config};if(e){let t=Ne(e,this.deep_link?ve+"?deep_link="+this.deep_link:ve);const s=await this.fetch(t,{headers:n,credentials:"include"});return vt(s,e,!!this.options.auth)}throw new Error(L)}async function vt(e,n,t){var s,i;if((e==null?void 0:e.status)===401&&!t){const a=await e.json(),o=(s=a==null?void 0:a.detail)==null?void 0:s.auth_message;throw new Error(o||ft)}else if((e==null?void 0:e.status)===401&&t)throw new Error(Te);if((e==null?void 0:e.status)===200){let a=await e.json();return a.root=n,(i=a.dependencies)==null||i.forEach((o,r)=>{o.id===void 0&&(o.id=r)}),a}else if((e==null?void 0:e.status)===401)throw new Error(ht);throw new Error(L)}async function bt(){const{http_protocol:e,host:n}=await Y(this.app_reference,this.options.hf_token);try{if(this.options.auth){const t=await Ce(e,n,this.options.auth,this.fetch,this.options.hf_token);t&&this.set_cookies(t)}}catch(t){throw Error(t.message)}}async function Ce(e,n,t,s,i){const a=new FormData;a.append("username",t==null?void 0:t[0]),a.append("password",t==null?void 0:t[1]);let o={};i&&(o.Authorization=`Bearer ${i}`);const r=await s(`${e}//${n}/${et}`,{headers:o,method:"POST",body:a,credentials:"include"});if(r.status===200)return r.headers.get("set-cookie");throw r.status===401?new Error(Te):new Error(pe)}function ce(e){if(e.startsWith("http")){const{protocol:n,host:t,pathname:s}=new URL(e);return{ws_protocol:n==="https:"?"wss":"ws",http_protocol:n,host:t+(s!=="/"?s:"")}}else if(e.startsWith("file:"))return{ws_protocol:"ws",http_protocol:"http:",host:"lite.local"};return{ws_protocol:"wss",http_protocol:"https:",host:new URL(e).host}}const Pe=e=>{let n=[];return e.split(/,(?=\s*[^\s=;]+=[^\s=;]+)/).forEach(t=>{const[s,i]=t.split(";")[0].split("=");s&&i&&n.push(`${s.trim()}=${i.trim()}`)}),n},de=/^[a-zA-Z0-9_\-\.]+\/[a-zA-Z0-9_\-\.]+$/,$t=/.*hf\.space\/{0,1}.*$/;async function Y(e,n){const t={};n&&(t.Authorization=`Bearer ${n}`);const s=e.trim().replace(/\/$/,"");if(de.test(s))try{const i=(await(await fetch(`https://huggingface.co/api/spaces/${s}/${Qe}`,{headers:t})).json()).host;return{space_id:e,...ce(i)}}catch{throw new Error(pe)}if($t.test(s)){const{ws_protocol:i,http_protocol:a,host:o}=ce(s);return{space_id:o.split("/")[0].replace(".hf.space",""),ws_protocol:i,http_protocol:a,host:o}}return{space_id:!1,...ce(s)}}const Ne=(...e)=>{try{return e.reduce((n,t)=>(n=n.replace(/\/+$/,""),t=t.replace(/^\/+/,""),new URL(t,n+"/").toString()))}catch{throw new Error(dt)}};function Et(e,n,t){const s={named_endpoints:{},unnamed_endpoints:{}};return Object.keys(e).forEach(i=>{(i==="named_endpoints"||i==="unnamed_endpoints")&&(s[i]={},Object.entries(e[i]).forEach(([a,{parameters:o,returns:r}])=>{var l,_,m,p;const g=((l=n.dependencies.find(c=>c.api_name===a||c.api_name===a.replace("/","")))==null?void 0:l.id)||t[a.replace("/","")]||-1,x=g!==-1?(_=n.dependencies.find(c=>c.id==g))==null?void 0:_.types:{generator:!1,cancel:!1};if(g!==-1&&((p=(m=n.dependencies.find(c=>c.id==g))==null?void 0:m.inputs)==null?void 0:p.length)!==o.length){const c=n.dependencies.find(h=>h.id==g).inputs.map(h=>{var D;return(D=n.components.find(N=>N.id===h))==null?void 0:D.type});try{c.forEach((h,D)=>{if(h==="state"){const N={component:"state",example:null,parameter_default:null,parameter_has_default:!0,parameter_name:null,hidden:!0};o.splice(D,0,N)}})}catch(h){console.error(h)}}const I=(c,h,D,N)=>({...c,description:St(c==null?void 0:c.type,D),type:kt(c==null?void 0:c.type,h,D,N)||""});s[i][a]={parameters:o.map(c=>I(c,c==null?void 0:c.component,c==null?void 0:c.serializer,"parameter")),returns:r.map(c=>I(c,c==null?void 0:c.component,c==null?void 0:c.serializer,"return")),type:x}}))}),s}function kt(e,n,t,s){if(n==="Api")return e.type;switch(e==null?void 0:e.type){case"string":return"string";case"boolean":return"boolean";case"number":return"number"}if(t==="JSONSerializable"||t==="StringSerializable")return"any";if(t==="ListStringSerializable")return"string[]";if(n==="Image")return s==="parameter"?"Blob | File | Buffer":"string";if(t==="FileSerializable")return(e==null?void 0:e.type)==="array"?s==="parameter"?"(Blob | File | Buffer)[]":"{ name: string; data: string; size?: number; is_file?: boolean; orig_name?: string}[]":s==="parameter"?"Blob | File | Buffer":"{ name: string; data: string; size?: number; is_file?: boolean; orig_name?: string}";if(t==="GallerySerializable")return s==="parameter"?"[(Blob | File | Buffer), (string | null)][]":"[{ name: string; data: string; size?: number; is_file?: boolean; orig_name?: string}, (string | null))][]"}function St(e,n){return n==="GallerySerializable"?"array of [file, label] tuples":n==="ListStringSerializable"?"array of strings":n==="FileSerializable"?"array of files or single file":e==null?void 0:e.description}function le(e,n){switch(e.msg){case"send_data":return{type:"data"};case"send_hash":return{type:"hash"};case"queue_full":return{type:"update",status:{queue:!0,message:De,stage:"error",code:e.code,success:e.success}};case"heartbeat":return{type:"heartbeat"};case"unexpected_error":return{type:"unexpected_error",status:{queue:!0,message:e.message,session_not_found:e.session_not_found,stage:"error",success:!1}};case"broken_connection":return{type:"broken_connection",status:{queue:!0,message:e.message,stage:"error",success:!1}};case"estimation":return{type:"update",status:{queue:!0,stage:n||"pending",code:e.code,size:e.queue_size,position:e.rank,eta:e.rank_eta,success:e.success}};case"progress":return{type:"update",status:{queue:!0,stage:"pending",code:e.code,progress_data:e.progress_data,success:e.success}};case"log":return{type:"log",data:e};case"process_generating":return{type:"generating",status:{queue:!0,message:e.success?null:e.output.error,stage:e.success?"generating":"error",code:e.code,progress_data:e.progress_data,eta:e.average_duration,changed_state_ids:e.success?e.output.changed_state_ids:void 0},data:e.success?e.output:null};case"process_streaming":return{type:"streaming",status:{queue:!0,message:e.output.error,stage:"streaming",time_limit:e.time_limit,code:e.code,progress_data:e.progress_data,eta:e.eta},data:e.output};case"process_completed":return"error"in e.output?{type:"update",status:{queue:!0,title:e.output.title,message:e.output.error,visible:e.output.visible,duration:e.output.duration,stage:"error",code:e.code,success:e.success}}:{type:"complete",status:{queue:!0,message:e.success?void 0:e.output.error,stage:e.success?"complete":"error",code:e.code,progress_data:e.progress_data,changed_state_ids:e.success?e.output.changed_state_ids:void 0},data:e.success?e.output:null};case"process_starts":return{type:"update",status:{queue:!0,stage:"pending",code:e.code,size:e.rank,position:0,success:e.success,eta:e.eta},original_msg:"process_starts"}}return{type:"none",status:{stage:"error",queue:!0}}}const xt=(e=[],n)=>{const t=n?n.parameters:[];if(Array.isArray(e))return n&&t.length>0&&e.length>t.length&&console.warn("Too many arguments provided for the endpoint."),e;const s=[],i=Object.keys(e);return t.forEach((a,o)=>{if(e.hasOwnProperty(a.parameter_name))s[o]=e[a.parameter_name];else if(a.parameter_has_default)s[o]=a.parameter_default;else throw new Error(`No value provided for required parameter: ${a.parameter_name}`)}),i.forEach(a=>{if(!t.some(o=>o.parameter_name===a))throw new Error(`Parameter \`${a}\` is not a valid keyword argument. Please refer to the API for usage.`)}),s.forEach((a,o)=>{if(a===void 0&&!t[o].parameter_has_default)throw new Error(`No value provided for required parameter: ${t[o].parameter_name}`)}),s};async function jt(){if(this.api_info)return this.api_info;const{hf_token:e}=this.options,{config:n}=this,t={"Content-Type":"application/json"};if(e&&(t.Authorization=`Bearer ${e}`),!!n)try{let s,i;if(typeof window<"u"&&window.gradio_api_info)i=window.gradio_api_info;else{if(je((n==null?void 0:n.version)||"2.0.0","3.30")<0)s=await this.fetch(lt,{method:"POST",body:JSON.stringify({serialize:!1,config:JSON.stringify(n)}),headers:t,credentials:"include"});else{const a=Ne(n.root,this.api_prefix,tt);s=await this.fetch(a,{headers:t,credentials:"include"})}if(!s.ok)throw new Error(R);i=await s.json()}return"api"in i&&(i=i.api),i.named_endpoints["/predict"]&&!i.unnamed_endpoints[0]&&(i.unnamed_endpoints[0]=i.named_endpoints["/predict"]),Et(i,n,this.api_map)}catch(s){throw new Error("Could not get API info. "+s.message)}}async function Ot(e,n,t){var s;const i={};(s=this==null?void 0:this.options)!=null&&s.hf_token&&(i.Authorization=`Bearer ${this.options.hf_token}`);const a=1e3,o=[];let r;for(let l=0;l<n.length;l+=a){const _=n.slice(l,l+a),m=new FormData;_.forEach(g=>{m.append("files",g)});try{const g=t?`${e}${this.api_prefix}/${ye}?upload_id=${t}`:`${e}${this.api_prefix}/${ye}`;r=await this.fetch(g,{method:"POST",body:m,headers:i,credentials:"include"})}catch(g){throw new Error(R+g.message)}if(!r.ok){const g=await r.text();return{error:`HTTP ${r.status}: ${g}`}}const p=await r.json();p&&o.push(...p)}return{files:o}}async function Dt(e,n,t,s){let i=(Array.isArray(e)?e:[e]).map(o=>o.blob);const a=i.filter(o=>o.size>(s??1/0));if(a.length)throw new Error(`File size exceeds the maximum allowed size of ${s} bytes: ${a.map(o=>o.name).join(", ")}`);return await Promise.all(await this.upload_files(n,i,t).then(async o=>{if(o.error)throw new Error(o.error);return o.files?o.files.map((r,l)=>new Q({...e[l],path:r,url:`${n}${this.api_prefix}/file=${r}`})):[]}))}async function on(e,n){return e.map(t=>new Q({path:t.name,orig_name:t.name,blob:t,size:t.size,mime_type:t.type,is_stream:n}))}class Q{constructor({path:n,url:t,orig_name:s,size:i,blob:a,is_stream:o,mime_type:r,alt_text:l,b64:_}){u(this,"path"),u(this,"url"),u(this,"orig_name"),u(this,"size"),u(this,"blob"),u(this,"is_stream"),u(this,"mime_type"),u(this,"alt_text"),u(this,"b64"),u(this,"meta",{_type:"gradio.FileData"}),this.path=n,this.url=t,this.orig_name=s,this.size=i,this.blob=t?void 0:a,this.is_stream=o,this.mime_type=r,this.alt_text=l,this.b64=_}}class ze{constructor(n,t){u(this,"type"),u(this,"command"),u(this,"meta"),u(this,"fileData"),this.type="command",this.command=n,this.meta=t}}const Tt=typeof process<"u"&&process.versions&&process.versions.node;function $e(e,n,t){for(;t.length>1;){const i=t.shift();if(typeof i=="string"||typeof i=="number")e=e[i];else throw new Error("Invalid key type")}const s=t.shift();if(typeof s=="string"||typeof s=="number")e[s]=n;else throw new Error("Invalid key type")}async function ue(e,n=void 0,t=[],s=!1,i=void 0){if(Array.isArray(e)){let a=[];return await Promise.all(e.map(async(o,r)=>{var l;let _=t.slice();_.push(String(r));const m=await ue(e[r],s?((l=i==null?void 0:i.parameters[r])==null?void 0:l.component)||void 0:n,_,!1,i);a=a.concat(m)})),a}else{if(globalThis.Buffer&&e instanceof globalThis.Buffer||e instanceof Blob)return[{path:t,blob:new Blob([e]),type:n}];if(typeof e=="object"&&e!==null){let a=[];for(const o of Object.keys(e)){const r=[...t,o],l=e[o];a=a.concat(await ue(l,void 0,r,!1,i))}return a}}return[]}function qt(e,n){var t,s;let i=(s=(t=n==null?void 0:n.dependencies)==null?void 0:t.find(a=>a.id==e))==null?void 0:s.queue;return i!=null?!i:!n.enable_queue}function Ct(e,n){return new Promise((t,s)=>{const i=new MessageChannel;i.port1.onmessage=({data:a})=>{i.port1.close(),t(a)},window.parent.postMessage(e,n,[i.port2])})}function an(e){if(typeof e=="string"){if(e.startsWith("http://")||e.startsWith("https://"))return{path:e,url:e,orig_name:e.split("/").pop()??"unknown",meta:{_type:"gradio.FileData"}};if(Tt)return new ze("upload_file",{path:e,name:e,orig_path:e})}else{if(typeof File<"u"&&e instanceof File)return new Blob([e]);if(e instanceof Buffer)return new Blob([e]);if(e instanceof Blob)return e}throw new Error("Invalid input: must be a URL, File, Blob, or Buffer object.")}function V(e,n,t,s,i=!1){if(s==="input"&&!i)throw new Error("Invalid code path. Cannot skip state inputs for input.");if(s==="output"&&i)return e;let a=[],o=0;const r=s==="input"?n.inputs:n.outputs;for(let l=0;l<r.length;l++){const _=r[l],m=t.find(p=>p.id===_);if((m==null?void 0:m.type)==="state"){if(i)if(e.length===r.length){const p=e[o];a.push(p),o++}else a.push(null);else{o++;continue}continue}else{const p=e[o];a.push(p),o++}}return a}async function Pt(e,n,t){const s=this;await Nt(s,n);const i=await ue(n,void 0,[],!0,t);return(await Promise.all(i.map(async({path:a,blob:o,type:r})=>{if(!o)return{path:a,type:r};const l=await s.upload_files(e,[o]),_=l.files&&l.files[0];return{path:a,file_url:_,type:r,name:typeof File<"u"&&o instanceof File?o==null?void 0:o.name:void 0}}))).forEach(({path:a,file_url:o,type:r,name:l})=>{if(r==="Gallery")$e(n,o,a);else if(o){const _=new Q({path:o,orig_name:l});$e(n,_,a)}}),n}async function Nt(e,n){var t,s;if(!((t=e.config)!=null&&t.root||(s=e.config)!=null&&s.root_url))throw new Error(qe);await Ae(e,n)}async function Ae(e,n,t=[]){for(const s in n)n[s]instanceof ze?await zt(e,n,s):typeof n[s]=="object"&&n[s]!==null&&await Ae(e,n[s],[...t,s])}async function zt(e,n,t){var s,i;let a=n[t];const o=((s=e.config)==null?void 0:s.root)||((i=e.config)==null?void 0:i.root_url);if(!o)throw new Error(qe);try{let r,l;if(typeof process<"u"&&process.versions&&process.versions.node){const g=await we(()=>import("./__vite-browser-external-DYxpcVy9-b25bb000.js"),[]);l=(await we(()=>import("./__vite-browser-external-DYxpcVy9-b25bb000.js"),[])).resolve(process.cwd(),a.meta.path),r=await g.readFile(l)}else throw new Error(_t);const _=new Blob([r],{type:"application/octet-stream"}),m=await e.upload_files(o,[_]),p=m.files&&m.files[0];if(p){const g=new Q({path:p,orig_name:a.meta.name||""});n[t]=g}}catch(r){console.error(gt,r)}}async function At(e,n,t){const s={"Content-Type":"application/json"};this.options.hf_token&&(s.Authorization=`Bearer ${this.options.hf_token}`);try{var i=await this.fetch(e,{method:"POST",body:JSON.stringify(n),headers:{...s,...t},credentials:"include"})}catch{return[{error:R},500]}let a,o;try{a=await i.json(),o=i.status}catch(r){a={error:`Could not parse server response: ${r}`},o=500}return[a,o]}async function Bt(e,n={}){let t=!1,s=!1;if(!this.config)throw new Error("Could not resolve app config");if(typeof e=="number")this.config.dependencies.find(i=>i.id==e);else{const i=e.replace(/^\//,"");this.config.dependencies.find(a=>a.id==this.api_map[i])}return new Promise(async(i,a)=>{const o=this.submit(e,n,null,null,!0);let r;for await(const l of o)l.type==="data"&&(s&&i(r),t=!0,r=l),l.type==="status"&&(l.stage==="error"&&a(l),l.stage==="complete"&&(s=!0,t&&i(r)))})}async function Z(e,n,t){let s=n==="subdomain"?`https://huggingface.co/api/spaces/by-subdomain/${e}`:`https://huggingface.co/api/spaces/${e}`,i,a;try{if(i=await fetch(s),a=i.status,a!==200)throw new Error;i=await i.json()}catch{t({status:"error",load_status:"error",message:ut,detail:"NOT_FOUND"});return}if(!i||a!==200)return;const{runtime:{stage:o},id:r}=i;switch(o){case"STOPPED":case"SLEEPING":t({status:"sleeping",load_status:"pending",message:"Space is asleep. Waking it up...",detail:o}),setTimeout(()=>{Z(e,n,t)},1e3);break;case"PAUSED":t({status:"paused",load_status:"error",message:"This space has been paused by the author. If you would like to try this demo, consider duplicating the space.",detail:o,discussions_enabled:await Ee(r)});break;case"RUNNING":case"RUNNING_BUILDING":t({status:"running",load_status:"complete",message:"Space is running.",detail:o});break;case"BUILDING":t({status:"building",load_status:"pending",message:"Space is building...",detail:o}),setTimeout(()=>{Z(e,n,t)},1e3);break;case"APP_STARTING":t({status:"starting",load_status:"pending",message:"Space is starting...",detail:o}),setTimeout(()=>{Z(e,n,t)},1e3);break;default:t({status:"space_error",load_status:"error",message:"This space is experiencing an issue.",detail:o,discussions_enabled:await Ee(r)});break}}const Be=async(e,n)=>{let t=0;const s=12,i=5e3;return new Promise(a=>{Z(e,de.test(e)?"space_name":"subdomain",o=>{n(o),o.status==="running"||o.status==="error"||o.status==="paused"||o.status==="space_error"?a():(o.status==="sleeping"||o.status==="building")&&(t<s?(t++,setTimeout(()=>{Be(e,n).then(a)},i)):a())})})},Lt=/^(?=[^]*\b[dD]iscussions{0,1}\b)(?=[^]*\b[dD]isabled\b)[^]*$/;async function Ee(e){try{const n=await fetch(`https://huggingface.co/api/spaces/${e}/discussions`,{method:"HEAD"}),t=n.headers.get("x-error-message");return!(!n.ok||t&&Lt.test(t))}catch{return!1}}async function It(e,n){const t={};n&&(t.Authorization=`Bearer ${n}`);try{const s=await fetch(`https://huggingface.co/api/spaces/${e}/${nt}`,{headers:t});if(s.status!==200)throw new Error("Space hardware could not be obtained.");const{hardware:i}=await s.json();return i.current}catch(s){throw new Error(s.message)}}async function Ut(e,n,t){const s={};t&&(s.Authorization=`Bearer ${t}`);const i={seconds:n};try{const a=await fetch(`https://huggingface.co/api/spaces/${e}/${st}`,{method:"POST",headers:{"Content-Type":"application/json",...s},body:JSON.stringify(i)});if(a.status!==200)throw new Error("Could not set sleep timeout on duplicated Space. Please visit *ADD HF LINK TO SETTINGS* to set a timeout manually to reduce billing charges.");return await a.json()}catch(a){throw new Error(a.message)}}const ke=["cpu-basic","cpu-upgrade","cpu-xl","t4-small","t4-medium","a10g-small","a10g-large","a10g-largex2","a10g-largex4","a100-large","zero-a10g","h100","h100x8"];async function Rt(e,n){const{hf_token:t,private:s,hardware:i,timeout:a,auth:o}=n;if(i&&!ke.includes(i))throw new Error(`Invalid hardware type provided. Valid types are: ${ke.map(h=>`"${h}"`).join(",")}.`);const{http_protocol:r,host:l}=await Y(e,t);let _=null;if(o){const h=await Ce(r,l,o,fetch);h&&(_=Pe(h))}const m={Authorization:`Bearer ${t}`,"Content-Type":"application/json",..._?{Cookie:_.join("; ")}:{}},p=(await(await fetch("https://huggingface.co/api/whoami-v2",{headers:m})).json()).name,g=e.split("/")[1],x={repository:`${p}/${g}`};s&&(x.private=!0);let I;try{i||(I=await It(e,t))}catch(h){throw Error(pe+h.message)}const c=i||I||"cpu-basic";x.hardware=c;try{const h=await fetch(`https://huggingface.co/api/spaces/${e}/duplicate`,{method:"POST",headers:m,body:JSON.stringify(x)});if(h.status===409)try{return await K.connect(`${p}/${g}`,n)}catch(N){throw console.error("Failed to connect Client instance:",N),N}else if(h.status!==200)throw new Error(h.statusText);const D=await h.json();return await Ut(`${p}/${g}`,a||300,t),await K.connect(Ft(D.url),n)}catch(h){throw new Error(h)}}function Ft(e){const n=/https:\/\/huggingface.co\/spaces\/([^/]+\/[^/]+)/,t=e.match(n);if(t)return t[1]}var B;class Wt extends TransformStream{constructor(n={allowCR:!1}){super({transform:(t,s)=>{for(t=H(this,B)+t;;){const i=t.indexOf(`
`),a=n.allowCR?t.indexOf("\r"):-1;if(a!==-1&&a!==t.length-1&&(i===-1||i-1>a)){s.enqueue(t.slice(0,a)),t=t.slice(a+1);continue}if(i===-1)break;const o=t[i-1]==="\r"?i-1:i;s.enqueue(t.slice(0,o)),t=t.slice(i+1)}Ye(this,B,t)},flush:t=>{if(H(this,B)==="")return;const s=n.allowCR&&H(this,B).endsWith("\r")?H(this,B).slice(0,-1):H(this,B);t.enqueue(s)}}),Ke(this,B,"")}}B=new WeakMap;function Jt(e){let n=new TextDecoderStream,t=new Wt({allowCR:!0});return e.pipeThrough(n).pipeThrough(t)}function Gt(e){let n=/[:]\s*/.exec(e),t=n&&n.index;if(t)return[e.substring(0,t),e.substring(t+n[0].length)]}function Se(e,n,t){e.get(n)||e.set(n,t)}async function*Mt(e,n){if(!e.body)return;let t=Jt(e.body),s,i=t.getReader(),a;for(;;){if(n&&n.aborted)return i.cancel();if(s=await i.read(),s.done)return;if(!s.value){a&&(yield a),a=void 0;continue}let[o,r]=Gt(s.value)||[];o&&(o==="data"?(a||(a={}),a[o]=a[o]?a[o]+`
`+r:r):o==="event"?(a||(a={}),a[o]=r):o==="id"?(a||(a={}),a[o]=+r||r):o==="retry"&&(a||(a={}),a[o]=+r||void 0))}}async function Ht(e,n){let t=new Request(e,n);Se(t.headers,"Accept","text/event-stream"),Se(t.headers,"Content-Type","application/json");let s=await fetch(t);if(!s.ok)throw s;return Mt(s,t.signal)}async function Vt(){let{event_callbacks:e,unclosed_events:n,pending_stream_messages:t,stream_status:s,config:i,jwt:a}=this;const o=this;if(!i)throw new Error("Could not resolve app config");s.open=!0;let r=null,l=new URLSearchParams({session_hash:this.session_hash}).toString(),_=new URL(`${i.root}${this.api_prefix}/${Oe}?${l}`);if(a&&_.searchParams.set("__sign",a),r=this.stream(_),!r){console.warn("Cannot connect to SSE endpoint: "+_.toString());return}r.onmessage=async function(m){let p=JSON.parse(m.data);if(p.msg==="close_stream"){he(s,o.abort_controller);return}const g=p.event_id;if(!g)await Promise.all(Object.keys(e).map(x=>e[x](p)));else if(e[g]&&i){p.msg==="process_completed"&&["sse","sse_v1","sse_v2","sse_v2.1","sse_v3"].includes(i.protocol)&&n.delete(g);let x=e[g];typeof window<"u"&&typeof document<"u"?setTimeout(x,0,p):x(p)}else t[g]||(t[g]=[]),t[g].push(p)},r.onerror=async function(m){console.error(m),await Promise.all(Object.keys(e).map(p=>e[p]({msg:"broken_connection",message:R})))}}function he(e,n){e&&(e.open=!1,n==null||n.abort())}function Zt(e,n,t){e[n]?t.data.forEach((s,i)=>{let a=Kt(e[n][i],s);e[n][i]=a,t.data[i]=a}):(e[n]=[],t.data.forEach((s,i)=>{e[n][i]=s}))}function Kt(e,n){return n.forEach(([t,s,i])=>{e=Yt(e,s,t,i)}),e}function Yt(e,n,t,s){if(n.length===0){if(t==="replace")return s;if(t==="append")return e+s;throw new Error(`Unsupported action: ${t}`)}let i=e;for(let o=0;o<n.length-1;o++)i=i[n[o]];const a=n[n.length-1];switch(t){case"replace":i[a]=s;break;case"append":i[a]+=s;break;case"add":Array.isArray(i)?i.splice(Number(a),0,s):i[a]=s;break;case"delete":Array.isArray(i)?i.splice(Number(a),1):delete i[a];break;default:throw new Error(`Unknown action: ${t}`)}return e}function Qt(e,n={}){const t={close:()=>{console.warn("Method not implemented.")},onerror:null,onmessage:null,onopen:null,readyState:0,url:e.toString(),withCredentials:!1,CONNECTING:0,OPEN:1,CLOSED:2,addEventListener:()=>{throw new Error("Method not implemented.")},dispatchEvent:()=>{throw new Error("Method not implemented.")},removeEventListener:()=>{throw new Error("Method not implemented.")}};return Ht(e,n).then(async s=>{t.readyState=t.OPEN;try{for await(const i of s)t.onmessage&&t.onmessage(i);t.readyState=t.CLOSED}catch(i){t.onerror&&t.onerror(i),t.readyState=t.CLOSED}}).catch(s=>{console.error(s),t.onerror&&t.onerror(s),t.readyState=t.CLOSED}),t}function Xt(e,n={},t,s,i){var a;try{let o=function(w){(i||Fe[w.type])&&m(w)},r=function(){for(Ge=!0;M.length>0;)M.shift()({value:void 0,done:!0})},l=function(w){M.length>0?M.shift()(w):oe.push(w)},_=function(w){l(en(w)),r()},m=function(w){l({value:w,done:!1})},p=function(){return oe.length>0?Promise.resolve(oe.shift()):new Promise(w=>M.push(w))};const{hf_token:g}=this.options,{fetch:x,app_reference:I,config:c,session_hash:h,api_info:D,api_map:N,stream_status:X,pending_stream_messages:ee,pending_diff_streams:te,event_callbacks:ne,unclosed_events:Le,post_data:se,options:F,api_prefix:W}=this,Ie=this;if(!D)throw new Error("No API found");if(!c)throw new Error("Could not resolve app config");let{fn_index:d,endpoint_info:fe,dependency:J}=tn(D,e,N,c),Ue=xt(n,fe),j,z,A=c.protocol??"ws",_e="",Re=()=>_e;const f=typeof e=="number"?"/predict":e;let G,E=null,T=!1,ie={},U=typeof window<"u"&&typeof document<"u"?new URLSearchParams(window.location.search).toString():"";const Fe=((a=F==null?void 0:F.events)==null?void 0:a.reduce((w,C)=>(w[C]=!0,w),{}))||{};async function We(){let w={},C={};A==="ws"?(j&&j.readyState===0?j.addEventListener("open",()=>{j.close()}):j.close(),w={fn_index:d,session_hash:h}):(w={event_id:E},C={event_id:E,session_hash:h,fn_index:d});try{if(!c)throw new Error("Could not resolve app config");"event_id"in C&&await x(`${c.root}${W}/${rt}`,{headers:{"Content-Type":"application/json"},method:"POST",body:JSON.stringify(C)}),await x(`${c.root}${W}/${at}`,{headers:{"Content-Type":"application/json"},method:"POST",body:JSON.stringify(w)})}catch{console.warn("The `/reset` endpoint could not be called. Subsequent endpoint results may be unreliable.")}}const Je=async w=>{await this._resolve_heartbeat(w)};async function ge(w){if(!c)return;let C=w.render_id;c.components=[...c.components.filter(k=>k.props.rendered_in!==C),...w.components],c.dependencies=[...c.dependencies.filter(k=>k.rendered_in!==C),...w.dependencies];const ae=c.components.some(k=>k.type==="state"),b=c.dependencies.some(k=>k.targets.some(q=>q[1]==="unload"));c.connect_heartbeat=ae||b,await Je(c),o({type:"render",data:w,endpoint:f,fn_index:d})}this.handle_blob(c.root,Ue,fe).then(async w=>{var C;if(G={data:V(w,J,c.components,"input",!0)||[],event_data:t,fn_index:d,trigger_id:s},qt(d,c))o({type:"status",endpoint:f,stage:"pending",queue:!1,fn_index:d,time:new Date}),se(`${c.root}${W}/run${f.startsWith("/")?f:`/${f}`}${U?"?"+U:""}`,{...G,session_hash:h}).then(([b,k])=>{const q=b.data;k==200?(o({type:"data",endpoint:f,fn_index:d,data:V(q,J,c.components,"output",F.with_null_state),time:new Date,event_data:t,trigger_id:s}),b.render_config&&ge(b.render_config),o({type:"status",endpoint:f,fn_index:d,stage:"complete",eta:b.average_duration,queue:!1,time:new Date})):o({type:"status",stage:"error",endpoint:f,fn_index:d,message:b.error,queue:!1,time:new Date})}).catch(b=>{o({type:"status",stage:"error",message:b.message,endpoint:f,fn_index:d,queue:!1,time:new Date})});else if(A=="ws"){const{ws_protocol:b,host:k}=await Y(I,g);o({type:"status",stage:"pending",queue:!0,endpoint:f,fn_index:d,time:new Date});let q=new URL(`${b}://${mt(k,c.root,!0)}/queue/join${U?"?"+U:""}`);this.jwt&&q.searchParams.set("__sign",this.jwt),j=new WebSocket(q),j.onclose=O=>{O.wasClean||o({type:"status",stage:"error",broken:!0,message:R,queue:!0,endpoint:f,fn_index:d,time:new Date})},j.onmessage=function(O){const S=JSON.parse(O.data),{type:$,status:v,data:y}=le(S,ie[d]);if($==="update"&&v&&!T)o({type:"status",endpoint:f,fn_index:d,time:new Date,...v}),v.stage==="error"&&j.close();else if($==="hash"){j.send(JSON.stringify({fn_index:d,session_hash:h}));return}else $==="data"?j.send(JSON.stringify({...G,session_hash:h})):$==="complete"?T=v:$==="log"?o({type:"log",title:y.title,log:y.log,level:y.level,endpoint:f,duration:y.duration,visible:y.visible,fn_index:d}):$==="generating"&&o({type:"status",time:new Date,...v,stage:v==null?void 0:v.stage,queue:!0,endpoint:f,fn_index:d});y&&(o({type:"data",time:new Date,data:V(y.data,J,c.components,"output",F.with_null_state),endpoint:f,fn_index:d,event_data:t,trigger_id:s}),T&&(o({type:"status",time:new Date,...T,stage:v==null?void 0:v.stage,queue:!0,endpoint:f,fn_index:d}),j.close()))},je(c.version||"2.0.0","3.6")<0&&addEventListener("open",()=>j.send(JSON.stringify({hash:h})))}else if(A=="sse"){o({type:"status",stage:"pending",queue:!0,endpoint:f,fn_index:d,time:new Date});var ae=new URLSearchParams({fn_index:d.toString(),session_hash:h}).toString();let b=new URL(`${c.root}${W}/${Oe}?${U?U+"&":""}${ae}`);if(this.jwt&&b.searchParams.set("__sign",this.jwt),z=this.stream(b),!z)return Promise.reject(new Error("Cannot connect to SSE endpoint: "+b.toString()));z.onmessage=async function(k){const q=JSON.parse(k.data),{type:O,status:S,data:$}=le(q,ie[d]);if(O==="update"&&S&&!T)o({type:"status",endpoint:f,fn_index:d,time:new Date,...S}),S.stage==="error"&&(z==null||z.close(),r());else if(O==="data"){let[v,y]=await se(`${c.root}${W}/queue/data`,{...G,session_hash:h,event_id:E});y!==200&&(o({type:"status",stage:"error",message:R,queue:!0,endpoint:f,fn_index:d,time:new Date}),z==null||z.close(),r())}else O==="complete"?T=S:O==="log"?o({type:"log",title:$.title,log:$.log,level:$.level,endpoint:f,duration:$.duration,visible:$.visible,fn_index:d}):(O==="generating"||O==="streaming")&&o({type:"status",time:new Date,...S,stage:S==null?void 0:S.stage,queue:!0,endpoint:f,fn_index:d});$&&(o({type:"data",time:new Date,data:V($.data,J,c.components,"output",F.with_null_state),endpoint:f,fn_index:d,event_data:t,trigger_id:s}),T&&(o({type:"status",time:new Date,...T,stage:S==null?void 0:S.stage,queue:!0,endpoint:f,fn_index:d}),z==null||z.close(),r()))}}else if(A=="sse_v1"||A=="sse_v2"||A=="sse_v2.1"||A=="sse_v3"){o({type:"status",stage:"pending",queue:!0,endpoint:f,fn_index:d,time:new Date});let b="";typeof window<"u"&&typeof document<"u"&&(b=(C=window==null?void 0:window.location)==null?void 0:C.hostname);const k=b.includes(".dev.")?`https://moon-${b.split(".")[1]}.dev.spaces.huggingface.tech`:"https://huggingface.co";(typeof window<"u"&&typeof document<"u"&&window.parent!=window&&window.supports_zerogpu_headers?Ct("zerogpu-headers",k):Promise.resolve(null)).then(q=>se(`${c.root}${W}/${Xe}?${U}`,{...G,session_hash:h},q)).then(async([q,O])=>{if(O===503)o({type:"status",stage:"error",message:De,queue:!0,endpoint:f,fn_index:d,time:new Date});else if(O!==200)o({type:"status",stage:"error",broken:!0,message:R,queue:!0,endpoint:f,fn_index:d,time:new Date});else{E=q.event_id,_e=E;let S=async function($){try{const{type:v,status:y,data:P,original_msg:Me}=le($,ie[d]);if(v=="heartbeat")return;if(v==="update"&&y&&!T)o({type:"status",endpoint:f,fn_index:d,time:new Date,original_msg:Me,...y});else if(v==="complete")T=y;else if(v=="unexpected_error"||v=="broken_connection"){console.error("Unexpected error",y==null?void 0:y.message);const He=v==="broken_connection";o({type:"status",stage:"error",message:(y==null?void 0:y.message)||"An Unexpected Error Occurred!",queue:!0,endpoint:f,broken:He,session_not_found:y==null?void 0:y.session_not_found,fn_index:d,time:new Date})}else if(v==="log"){o({type:"log",title:P.title,log:P.log,level:P.level,endpoint:f,duration:P.duration,visible:P.visible,fn_index:d});return}else(v==="generating"||v==="streaming")&&(o({type:"status",time:new Date,...y,stage:y==null?void 0:y.stage,queue:!0,endpoint:f,fn_index:d}),P&&J.connection!=="stream"&&["sse_v2","sse_v2.1","sse_v3"].includes(A)&&Zt(te,E,P));P&&(o({type:"data",time:new Date,data:V(P.data,J,c.components,"output",F.with_null_state),endpoint:f,fn_index:d}),P.render_config&&await ge(P.render_config),T&&(o({type:"status",time:new Date,...T,stage:y==null?void 0:y.stage,queue:!0,endpoint:f,fn_index:d}),r())),((y==null?void 0:y.stage)==="complete"||(y==null?void 0:y.stage)==="error")&&(ne[E]&&delete ne[E],E in te&&delete te[E])}catch(v){console.error("Unexpected client exception",v),o({type:"status",stage:"error",message:"An Unexpected Error Occurred!",queue:!0,endpoint:f,fn_index:d,time:new Date}),["sse_v2","sse_v2.1","sse_v3"].includes(A)&&(he(X,Ie.abort_controller),X.open=!1,r())}};E in ee&&(ee[E].forEach($=>S($)),delete ee[E]),ne[E]=S,Le.add(E),X.open||await this.open_stream()}})}});let Ge=!1;const oe=[],M=[],me={[Symbol.asyncIterator]:()=>me,next:p,throw:async w=>(_(w),p()),return:async()=>(r(),p()),cancel:We,event_id:Re};return me}catch(o){throw console.error("Submit function encountered an error:",o),o}}function en(e){return{then:(n,t)=>t(e)}}function tn(e,n,t,s){let i,a,o;if(typeof n=="number")i=n,a=e.unnamed_endpoints[i],o=s.dependencies.find(r=>r.id==n);else{const r=n.replace(/^\//,"");i=t[r],a=e.named_endpoints[n.trim()],o=s.dependencies.find(l=>l.id==t[r])}if(typeof i!="number")throw new Error("There is no endpoint matching that name of fn_index matching that number.");return{fn_index:i,endpoint_info:a,dependency:o}}class K{constructor(n,t={events:["data"]}){u(this,"app_reference"),u(this,"options"),u(this,"deep_link",null),u(this,"config"),u(this,"api_prefix",""),u(this,"api_info"),u(this,"api_map",{}),u(this,"session_hash",Math.random().toString(36).substring(2)),u(this,"jwt",!1),u(this,"last_status",{}),u(this,"cookies",null),u(this,"stream_status",{open:!1}),u(this,"closed",!1),u(this,"pending_stream_messages",{}),u(this,"pending_diff_streams",{}),u(this,"event_callbacks",{}),u(this,"unclosed_events",new Set),u(this,"heartbeat_event",null),u(this,"abort_controller",null),u(this,"stream_instance",null),u(this,"current_payload"),u(this,"ws_map",{}),u(this,"view_api"),u(this,"upload_files"),u(this,"upload"),u(this,"handle_blob"),u(this,"post_data"),u(this,"submit"),u(this,"predict"),u(this,"open_stream"),u(this,"resolve_config"),u(this,"resolve_cookies");var s;this.app_reference=n,this.deep_link=((s=t.query_params)==null?void 0:s.deep_link)||null,t.events||(t.events=["data"]),this.options=t,this.current_payload={},this.view_api=jt.bind(this),this.upload_files=Ot.bind(this),this.handle_blob=Pt.bind(this),this.post_data=At.bind(this),this.submit=Xt.bind(this),this.predict=Bt.bind(this),this.open_stream=Vt.bind(this),this.resolve_config=yt.bind(this),this.resolve_cookies=bt.bind(this),this.upload=Dt.bind(this),this.fetch=this.fetch.bind(this),this.handle_space_success=this.handle_space_success.bind(this),this.stream=this.stream.bind(this)}get_url_config(n=null){if(!this.config)throw new Error(L);n===null&&(n=window.location.href);const t=o=>o.replace(/^\/+|\/+$/g,"");let s=t(new URL(this.config.root).pathname),i=t(new URL(n).pathname),a;return i.startsWith(s)?a=t(i.substring(s.length)):a="",this.get_page_config(a)}get_page_config(n){if(!this.config)throw new Error(L);let t=this.config;return n in t.page||(n=""),{...t,current_page:n,layout:t.page[n].layout,components:t.components.filter(s=>t.page[n].components.includes(s.id)),dependencies:this.config.dependencies.filter(s=>t.page[n].dependencies.includes(s.id))}}fetch(n,t){const s=new Headers((t==null?void 0:t.headers)||{});if(this&&this.cookies&&s.append("Cookie",this.cookies),this&&this.options.headers)for(const i in this.options.headers)s.append(i,this.options.headers[i]);return fetch(n,{...t,headers:s})}stream(n){const t=new Headers;if(this&&this.cookies&&t.append("Cookie",this.cookies),this&&this.options.headers)for(const s in this.options.headers)t.append(s,this.options.headers[s]);return this&&this.options.hf_token&&t.append("Authorization",`Bearer ${this.options.hf_token}`),this.abort_controller=new AbortController,this.stream_instance=Qt(n.toString(),{credentials:"include",headers:t,signal:this.abort_controller.signal}),this.stream_instance}async init(){var n;this.options.auth&&await this.resolve_cookies(),await this._resolve_config().then(({config:t})=>this._resolve_heartbeat(t)),this.api_info=await this.view_api(),this.api_map=wt(((n=this.config)==null?void 0:n.dependencies)||[])}async _resolve_heartbeat(n){if(n&&(this.config=n,this.api_prefix=n.api_prefix||"",this.config&&this.config.connect_heartbeat&&this.config.space_id&&this.options.hf_token&&(this.jwt=await be(this.config.space_id,this.options.hf_token,this.cookies))),n.space_id&&this.options.hf_token&&(this.jwt=await be(n.space_id,this.options.hf_token)),this.config&&this.config.connect_heartbeat){const t=new URL(`${this.config.root}${this.api_prefix}/${it}/${this.session_hash}`);this.jwt&&t.searchParams.set("__sign",this.jwt),this.heartbeat_event||(this.heartbeat_event=this.stream(t))}}static async connect(n,t={events:["data"]}){const s=new this(n,t);return t.session_hash&&(s.session_hash=t.session_hash),await s.init(),s}async reconnect(){const n=new URL(`${this.config.root}${this.api_prefix}/${ct}`);let t;try{const s=await this.fetch(n);if(!s.ok)throw new Error;t=(await s.json()).app_id}catch{return"broken"}return t!==this.config.app_id?"changed":"connected"}close(){this.closed=!0,he(this.stream_status,this.abort_controller)}set_current_payload(n){this.current_payload=n}static async duplicate(n,t={events:["data"]}){return Rt(n,t)}async _resolve_config(){const{http_protocol:n,host:t,space_id:s}=await Y(this.app_reference,this.options.hf_token),{status_callback:i}=this.options;s&&i&&await Be(s,i);let a;try{let o=`${n}//${t}`;if(a=await this.resolve_config(o),!a)throw new Error(L);return this.config_success(a)}catch(o){if(s&&i)Z(s,de.test(s)?"space_name":"subdomain",this.handle_space_success);else throw i&&i({status:"error",message:"Could not load this space.",load_status:"error",detail:"NOT_FOUND"}),Error(o)}}async config_success(n){if(this.config=n,this.api_prefix=n.api_prefix||"",this.config.auth_required)return this.prepare_return_obj();try{this.api_info=await this.view_api()}catch(t){console.error(pt+t.message)}return this.prepare_return_obj()}async handle_space_success(n){var t;if(!this)throw new Error(L);const{status_callback:s}=this.options;if(s&&s(n),n.status==="running")try{if(this.config=await this._resolve_config(),this.api_prefix=((t=this==null?void 0:this.config)==null?void 0:t.api_prefix)||"",!this.config)throw new Error(L);return await this.config_success(this.config)}catch(i){throw s&&s({status:"error",message:"Could not load this space.",load_status:"error",detail:"NOT_FOUND"}),i}}async component_server(n,t,s){var i;if(!this.config)throw new Error(L);const a={},{hf_token:o}=this.options,{session_hash:r}=this;o&&(a.Authorization=`Bearer ${this.options.hf_token}`);let l,_=this.config.components.find(p=>p.id===n);(i=_==null?void 0:_.props)!=null&&i.root_url?l=_.props.root_url:l=this.config.root;let m;if("binary"in s){m=new FormData;for(const p in s.data)p!=="binary"&&m.append(p,s.data[p]);m.set("component_id",n.toString()),m.set("fn_name",t),m.set("session_hash",r)}else m=JSON.stringify({data:s,component_id:n,fn_name:t,session_hash:r}),a["Content-Type"]="application/json";o&&(a.Authorization=`Bearer ${o}`);try{const p=await this.fetch(`${l}${this.api_prefix}/${ot}/`,{method:"POST",body:m,headers:a,credentials:"include"});if(!p.ok)throw new Error("Could not connect to component server: "+p.statusText);return await p.json()}catch(p){console.warn(p)}}set_cookies(n){this.cookies=Pe(n).join("; ")}prepare_return_obj(){return{config:this.config,predict:this.predict,submit:this.submit,view_api:this.view_api,component_server:this.component_server}}async connect_ws(n){return new Promise((t,s)=>{let i;try{i=new WebSocket(n)}catch{this.ws_map[n]="failed";return}this.ws_map[n]="pending",i.onopen=()=>{this.ws_map[n]=i,t()},i.onerror=a=>{console.error("WebSocket error:",a),this.close_ws(n),this.ws_map[n]="failed",t()},i.onclose=()=>{this.ws_map[n]="closed"},i.onmessage=a=>{}})}async send_ws_message(n,t){if(!(n in this.ws_map))await this.connect_ws(n);else if(this.ws_map[n]==="pending"||this.ws_map[n]==="closed"||this.ws_map[n]==="failed")return;const s=this.ws_map[n];s instanceof WebSocket?s.send(JSON.stringify(t)):this.post_data(n,t)}async close_ws(n){if(n in this.ws_map){const t=this.ws_map[n];t instanceof WebSocket&&(t.close(),delete this.ws_map[n])}}}async function rn(e,n={events:["data"]}){return await K.connect(e,n)}async function cn(e,n){return await K.duplicate(e,n)}export{K as Client,Q as FileData,ft as MISSING_CREDENTIALS_MSG,rn as client,cn as duplicate,an as handle_file,Bt as predict,on as prepare_files,Xt as submit,Dt as upload,Ot as upload_files};
